{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Payment Method" %} - {{ block.super }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{% trans "Payment Method" %}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'billing:subscribe' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> {% trans "Back to Plans" %}
        </a>
    </div>
</div>

{% if pending_subscription %}
    <!-- Order Summary -->
    <div class="row mb-4">
        <div class="col-md-6 mx-auto">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">{% trans "Order Summary" %}</h5>
                    <div class="d-flex justify-content-between mb-2">
                        <span>{{ plan.name }}</span>
                        <span>${{ pending_subscription.amount }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>{% trans "Billing Cycle" %}</span>
                        <span>{{ pending_subscription.billing_cycle|title }}</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fw-bold">
                        <span>{% trans "Total" %}</span>
                        <span>${{ pending_subscription.amount }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment Method Selection -->
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">{% trans "Choose Payment Method" %}</h5>
                    
                    <!-- Existing Payment Methods -->
                    {% if payment_methods %}
                        <div class="mb-4">
                            <h6>{% trans "Saved Payment Methods" %}</h6>
                            {% for method in payment_methods %}
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="payment_method" 
                                           id="method{{ method.id }}" value="{{ method.id }}">
                                    <label class="form-check-label" for="method{{ method.id }}">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>{{ method }}</strong>
                                                <br><small class="text-muted">{{ method.get_method_type_display }}</small>
                                            </div>
                                            {% if method.is_default %}
                                                <span class="badge bg-primary">{% trans "Default" %}</span>
                                            {% endif %}
                                        </div>
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <hr>
                    {% endif %}
                    
                    <!-- Add New Payment Method -->
                    <div class="mb-4">
                        <h6>{% trans "Add New Payment Method" %}</h6>
                        
                        <!-- PayPal Option -->
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="payment_method" 
                                   id="paypal" value="paypal">
                            <label class="form-check-label" for="paypal">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-paypal text-primary me-2" style="font-size: 1.5rem;"></i>
                                    <div>
                                        <strong>PayPal</strong>
                                        <br><small class="text-muted">{% trans "Pay with your PayPal account" %}</small>
                                    </div>
                                </div>
                            </label>
                        </div>
                        
                        <!-- Stripe Option -->
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="payment_method" 
                                   id="stripe" value="stripe">
                            <label class="form-check-label" for="stripe">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-credit-card text-info me-2" style="font-size: 1.5rem;"></i>
                                    <div>
                                        <strong>{% trans "Credit/Debit Card" %}</strong>
                                        <br><small class="text-muted">{% trans "Visa, Mastercard, American Express" %}</small>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Payment Processing Notice -->
                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle"></i> {% trans "Secure Payment Processing" %}</h6>
                        <p class="mb-0">
                            {% trans "Your payment information is processed securely through our certified payment partners. We never store your complete payment details on our servers." %}
                        </p>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary btn-lg" id="proceedPayment" disabled>
                            <i class="bi bi-lock"></i> {% trans "Complete Subscription" %}
                        </button>
                        <small class="text-muted text-center">
                            {% trans "You will be redirected to secure payment processing" %}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Security Information -->
    <div class="row mt-4">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">{% trans "Security & Privacy" %}</h5>
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <i class="bi bi-shield-check display-4 text-success"></i>
                            <h6 class="mt-2">{% trans "SSL Encrypted" %}</h6>
                            <small class="text-muted">{% trans "256-bit encryption" %}</small>
                        </div>
                        <div class="col-md-4 text-center">
                            <i class="bi bi-lock display-4 text-primary"></i>
                            <h6 class="mt-2">{% trans "PCI Compliant" %}</h6>
                            <small class="text-muted">{% trans "Industry standards" %}</small>
                        </div>
                        <div class="col-md-4 text-center">
                            <i class="bi bi-check-circle display-4 text-info"></i>
                            <h6 class="mt-2">{% trans "Trusted Partners" %}</h6>
                            <small class="text-muted">{% trans "PayPal & Stripe" %}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% else %}
    <div class="alert alert-warning">
        <h5><i class="bi bi-exclamation-triangle"></i> {% trans "No Pending Subscription" %}</h5>
        <p>{% trans "No subscription information found. Please select a plan first." %}</p>
        <a href="{% url 'billing:subscribe' %}" class="btn btn-primary">
            {% trans "Choose Plan" %}
        </a>
    </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const paymentMethodRadios = document.querySelectorAll('input[name="payment_method"]');
    const proceedButton = document.getElementById('proceedPayment');
    
    // Enable proceed button when payment method is selected
    paymentMethodRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            proceedButton.disabled = false;
        });
    });
    
    // Handle payment processing
    proceedButton.addEventListener('click', function() {
        const selectedMethod = document.querySelector('input[name="payment_method"]:checked');
        
        if (!selectedMethod) {
            alert('{% trans "Please select a payment method" %}');
            return;
        }
        
        const methodValue = selectedMethod.value;
        
        // Show loading state
        this.disabled = true;
        this.innerHTML = '<i class="bi bi-hourglass-split"></i> {% trans "Processing..." %}';
        
        if (methodValue === 'paypal') {
            // Redirect to PayPal
            alert('{% trans "PayPal integration coming soon. Please contact support." %}');
            this.disabled = false;
            this.innerHTML = '<i class="bi bi-lock"></i> {% trans "Complete Subscription" %}';
        } else if (methodValue === 'stripe') {
            // Redirect to Stripe
            alert('{% trans "Stripe integration coming soon. Please contact support." %}');
            this.disabled = false;
            this.innerHTML = '<i class="bi bi-lock"></i> {% trans "Complete Subscription" %}';
        } else {
            // Use existing payment method
            alert('{% trans "Payment processing with saved method coming soon." %}');
            this.disabled = false;
            this.innerHTML = '<i class="bi bi-lock"></i> {% trans "Complete Subscription" %}';
        }
    });
});
</script>
{% endblock %}